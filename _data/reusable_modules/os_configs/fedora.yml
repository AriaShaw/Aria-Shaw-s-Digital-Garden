# Fedora 39 Configuration for Odoo
# Last Verified: 2025-10-29
# Data Sources: Official Fedora documentation, community guides, package repositories

os_info:
  name: "Fedora"
  version: "39"
  family: "RHEL"
  architecture: ["x86_64", "aarch64"]
  release_date: "2023-11-07"
  support_until: "2024-11-12"
  package_manager: "dnf"
  init_system: "systemd"
  description: "Cutting-edge Linux distribution with latest software packages"

repositories:
  rpmfusion:
    name: "RPM Fusion Free"
    install_command: |
      sudo dnf install -y https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
      sudo dnf install -y https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

  postgresql:
    name: "PostgreSQL Official Repository"
    install_command: |
      sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/F-39-x86_64/pgdg-fedora-repo-latest.noarch.rpm

  nodejs:
    name: "NodeSource Repository"
    install_command: |
      curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -

system_packages:
  development:
    - gcc
    - gcc-c++
    - make
    - git
    - vim-enhanced
    - wget
    - curl
    - tar
    - "@Development Tools"
    - "@C Development Tools and Libraries"

  python:
    - python3.12
    - python3.12-devel
    - python3-pip
    - python3-setuptools
    - python3-wheel
    - python3-virtualenv

  libraries:
    - bzip2-devel
    - redhat-rpm-config
    - libxslt-devel
    - openldap-devel
    - libjpeg-turbo-devel
    - freetype-devel
    - libxml2-devel
    - libzip-devel
    - zlib-devel
    - openssl-devel
    - libffi-devel
    - readline-devel
    - ncurses-devel
    - sqlite-devel
    - tk-devel
    - gdbm-devel
    - xz-devel
    - libpng-devel
    - libtiff-devel
    - libwebp-devel
    - cairo-devel
    - pango-devel

  postgresql:
    - postgresql16-server
    - postgresql16
    - postgresql16-devel
    - postgresql16-contrib

  nodejs:
    - nodejs
    - npm

  additional:
    - nginx
    - certbot
    - python3-certbot-nginx
    - firewalld
    - fail2ban-server
    - redis
    - memcached

installation_commands:
  system_update: |
    sudo dnf update -y
    sudo dnf upgrade -y

  install_dependencies: |
    # Install development tools
    sudo dnf groupinstall -y "Development Tools" "C Development Tools and Libraries"

    # Install Python 3.12 (Fedora 39 default)
    sudo dnf install -y python3 python3-devel python3-pip python3-setuptools python3-wheel

    # Install required libraries
    sudo dnf install -y gcc gcc-c++ git vim-enhanced wget curl \
      bzip2-devel redhat-rpm-config libxslt-devel openldap-devel \
      libjpeg-turbo-devel freetype-devel libxml2-devel libzip-devel \
      zlib-devel openssl-devel libffi-devel readline-devel \
      ncurses-devel sqlite-devel tk-devel gdbm-devel xz-devel \
      libpng-devel libtiff-devel libwebp-devel cairo-devel pango-devel

  install_postgresql: |
    # Add PostgreSQL 16 repository
    sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/F-39-x86_64/pgdg-fedora-repo-latest.noarch.rpm

    # Disable built-in PostgreSQL module
    sudo dnf module disable -y postgresql

    # Install PostgreSQL 16
    sudo dnf install -y postgresql16-server postgresql16 postgresql16-devel

    # Initialize database
    sudo /usr/pgsql-16/bin/postgresql-16-setup initdb

    # Enable and start PostgreSQL
    sudo systemctl enable postgresql-16
    sudo systemctl start postgresql-16

    # Create Odoo database user
    sudo -u postgres createuser -s odoo

  install_nodejs: |
    # Install Node.js 20 LTS
    curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
    sudo dnf install -y nodejs

    # Install global packages
    sudo npm install -g less less-plugin-clean-css rtlcss

    # Verify installation
    node --version
    npm --version

  install_wkhtmltopdf: |
    # Install wkhtmltopdf dependencies
    sudo dnf install -y libXrender libXext fontconfig

    # Download and install wkhtmltopdf for Fedora
    wget https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-3/wkhtmltox-0.12.6.1-3.almalinux9.x86_64.rpm
    sudo dnf install -y ./wkhtmltox-0.12.6.1-3.almalinux9.x86_64.rpm

  create_odoo_user: |
    # Create dedicated system user for Odoo
    sudo useradd -m -d /opt/odoo -U -r -s /bin/bash odoo

  setup_python_venv: |
    # Create Python virtual environment
    sudo -u odoo python3 -m venv /opt/odoo/venv

    # Upgrade pip in virtual environment
    sudo -u odoo /opt/odoo/venv/bin/pip install --upgrade pip wheel setuptools

  setup_firewall: |
    # Enable and configure firewall
    sudo systemctl enable firewalld
    sudo systemctl start firewalld

    # Open required ports
    sudo firewall-cmd --permanent --zone=public --add-service=http
    sudo firewall-cmd --permanent --zone=public --add-service=https
    sudo firewall-cmd --permanent --zone=public --add-port=8069/tcp
    sudo firewall-cmd --permanent --zone=public --add-port=8072/tcp

    # Reload firewall
    sudo firewall-cmd --reload

selinux_configuration:
  mode: "enforcing"  # Fedora keeps SELinux enforcing by default
  commands: |
    # Configure SELinux for Odoo
    sudo setsebool -P httpd_can_network_connect 1
    sudo semanage port -a -t http_port_t -p tcp 8069
    sudo semanage port -a -t http_port_t -p tcp 8072

    # If issues persist, set to permissive
    # sudo setenforce 0
    # sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config

postgresql_configuration:
  version: "16"
  data_directory: "/var/lib/pgsql/16/data"
  config_file: "/var/lib/pgsql/16/data/postgresql.conf"
  hba_file: "/var/lib/pgsql/16/data/pg_hba.conf"

  tuning_parameters:
    shared_buffers: "512MB"
    effective_cache_size: "2GB"
    maintenance_work_mem: "128MB"
    checkpoint_completion_target: "0.9"
    wal_buffers: "16MB"
    default_statistics_target: "100"
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    work_mem: "4MB"
    min_wal_size: "1GB"
    max_wal_size: "4GB"
    max_connections: "200"

  hba_config: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     peer
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             ::1/128                 scram-sha-256

systemd_service:
  service_file_path: "/etc/systemd/system/odoo.service"
  service_content: |
    [Unit]
    Description=Odoo ERP System
    Documentation=https://www.odoo.com/documentation
    Requires=postgresql-16.service
    After=network.target postgresql-16.service

    [Service]
    Type=simple
    SyslogIdentifier=odoo
    PermissionsStartOnly=true
    User=odoo
    Group=odoo
    ExecStart=/opt/odoo/venv/bin/python3 /opt/odoo/odoo/odoo-bin \
      --config=/etc/odoo/odoo.conf \
      --logfile=/var/log/odoo/odoo-server.log
    StandardOutput=journal+console
    KillMode=mixed
    Restart=on-failure
    RestartSec=5
    LimitNOFILE=65536

    [Install]
    WantedBy=multi-user.target

nginx_configuration:
  config_file: "/etc/nginx/conf.d/odoo.conf"
  sample_config: |
    upstream odoo {
        server 127.0.0.1:8069;
    }

    upstream odoochat {
        server 127.0.0.1:8072;
    }

    server {
        listen 80;
        server_name your-domain.com;

        # Redirect to HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
        ssl_session_timeout 30m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;

        access_log /var/log/nginx/odoo.access.log;
        error_log /var/log/nginx/odoo.error.log;

        client_max_body_size 100M;
        proxy_read_timeout 720s;
        proxy_connect_timeout 720s;
        proxy_send_timeout 720s;

        # Add Headers
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;

        # Main application
        location / {
            proxy_redirect off;
            proxy_pass http://odoo;
        }

        # Long polling
        location /longpolling {
            proxy_pass http://odoochat;
        }

        # Cache static files
        location ~* /web/static/ {
            proxy_cache_valid 200 90m;
            proxy_buffering on;
            expires 864000;
            proxy_pass http://odoo;
        }

        # Gzip compression
        gzip on;
        gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript;
    }

troubleshooting:
  common_issues:
    - issue: "ModuleNotFoundError: No module named 'module_name'"
      solution: |
        Activate virtual environment and install dependencies:
        source /opt/odoo/venv/bin/activate
        pip install -r requirements.txt

    - issue: "psycopg2 installation fails"
      solution: |
        Install PostgreSQL development packages:
        sudo dnf install postgresql16-devel
        pip install psycopg2-binary

    - issue: "SELinux preventing connections"
      solution: |
        Configure SELinux properly:
        sudo setsebool -P httpd_can_network_connect 1
        sudo semanage port -a -t http_port_t -p tcp 8069

    - issue: "Permission denied on log file"
      solution: |
        Create log directory with proper permissions:
        sudo mkdir -p /var/log/odoo
        sudo chown -R odoo:odoo /var/log/odoo

    - issue: "Firewall blocking access"
      solution: |
        Check and configure firewall:
        sudo firewall-cmd --list-all
        sudo firewall-cmd --permanent --add-port=8069/tcp
        sudo firewall-cmd --reload

    - issue: "Python version conflicts"
      solution: |
        Use alternatives to set default Python:
        sudo alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

performance_tuning:
  system_limits: |
    # Add to /etc/security/limits.conf
    odoo soft nofile 65536
    odoo hard nofile 65536
    odoo soft nproc 32768
    odoo hard nproc 32768

  kernel_parameters: |
    # Add to /etc/sysctl.conf
    net.ipv4.tcp_keepalive_time = 60
    net.ipv4.tcp_keepalive_intvl = 10
    net.ipv4.tcp_keepalive_probes = 6
    net.core.somaxconn = 4096
    vm.swappiness = 10

  systemd_limits: |
    # Add to service file or /etc/systemd/system/odoo.service.d/override.conf
    [Service]
    LimitNOFILE=65536
    LimitNPROC=32768

compatibility_notes:
  odoo_versions:
    - version: "14"
      compatible: true
      notes: "Works with Python 3.8+"
    - version: "15"
      compatible: true
      notes: "Works with Python 3.8+"
    - version: "16"
      compatible: true
      notes: "Works with Python 3.8+"
    - version: "17"
      compatible: true
      notes: "Requires Python 3.10+, fully supported"
    - version: "18"
      compatible: true
      notes: "Requires Python 3.10+, fully supported"

  notes: |
    - Fedora 39 ships with Python 3.12 by default
    - Bleeding edge packages may cause compatibility issues
    - SELinux is enforcing by default, may need configuration
    - Short release cycle (6 months support)
    - Consider Fedora Server for production deployments
    - PostgreSQL 16 provides best performance